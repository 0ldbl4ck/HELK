# Hostnames and Domains Enrichments and Additions
# HELK build Stage: Alpha
# Author: Nate Guagenti (@neu5ron)
# License: GPL-3.0

filter {
  # Copy some values that could be dst_host_name if dst_host_name doesn't exist and those variables do
  if [target_server_name] and ![dst_host_name] {
    mutate {
      copy => { "target_server_name" => "dst_host_name" }
    }
  }
  if [target_host_name] and ![dst_host_name] {
    mutate {
      copy => { "target_host_name" => "dst_host_name" }
    }
  }
  if [service_name] and ![dst_host_name] {
    mutate {
      copy => { "service_name" => "dst_host_name" }
    }
  }
  if [dns_query_name] and ![dst_host_name] {
    mutate {
      copy => { "dns_query_name" => "dst_host_name" }
      add_field => { "dst_host_name_type" => "dns" }
    }
  }
  if [http_request_header_host] and ![dst_host_name] {
    mutate {
      copy => { "http_request_header_host" => "dst_host_name" }
      add_field => { "dst_host_name_type" => "http" }
    }
  }
  if [tls_server_name] and ![dst_host_name] {
    mutate {
      copy => { "tls_server_name" => "dst_host_name" }
      add_field => { "dst_host_name_type" => "tls" }
    }
  }
  
  # Add/Enrich
  if [dst_host_name] { 
    ruby {
      path => "/usr/share/logstash/pipeline/ruby/host_name_domain_enrich_additions.rb"
      script_params => { "domain" => "dst_host_name" }
      tag_on_exception =>  "_rubyexception-dst_host_name-enrich_and_add"
      add_field => { "etl_pipeline" => "dst_host_name-enrich_and_add" }
    }
  }
  
  # Add/Enrich
  if [src_host_name] { 
    ruby {
      path => "/usr/share/logstash/pipeline/ruby/host_name_domain_enrich_additions.rb"
      script_params => { "domain" => "src_host_name" }
      tag_on_exception =>  "_rubyexception-src_host_name-enrich_and_add"
      add_field => { "etl_pipeline" => "src_host_name-enrich_and_add" }
    }
  }
  
}
